pipeline {
  agent any

  environment {
    WAR_NAME = 'maven_web_application.war'
    TOMCAT_WEBAPPS = '/opt/tomcat9/webapps'
  }

  stages {
    stage('Checkout') {
      steps { checkout scm }
    }

    stage('Build') {
      steps {
        sh 'mvn -B clean package -DskipTests'
      }
    }

    stage('Deploy') {
      steps {
        script {
          // find WAR
          def war = sh(script: "ls target/*.war | head -n 1", returnStdout: true).trim()
          if (!war) { error "WAR not found in target/" }

          echo "Copying ${war} to ${TOMCAT_WEBAPPS}/${env.WAR_NAME}"
          sh "cp ${war} ${TOMCAT_WEBAPPS}/${env.WAR_NAME}"

          echo "Restarting Tomcat"
          sh "sudo systemctl restart tomcat"
        }
      }
    }
  }

  post {
    success { echo "✅ Deployment successful" }
    failure { echo "❌ Deployment failed" }
  }
}
